{% extends "layout.html" %}
{% block title %}Login{% endblock %}
{% block content %}
<div class="flex items-center justify-center min-h-screen" style="margin-top: -80px;">
  <div class="mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-16 rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm">
    <h1 class="text-center text-3xl font-bold text-gray-900">Welcome to the MY Buttsite!</h1>
    <div class="mt-2 h-1 w-20 bg-accent mx-auto rounded-full"></div>

    {% if CAS_ENABLED %}
      <p class="mt-6 text-center">Login with Yale Email</p>
      <form method="POST" class="mt-6">
        <button type="submit"
          class="inline-flex w-full items-center justify-center rounded-xl bg-accent px-4 py-3 font-semibold text-white shadow-sm hover:brightness-95 focus:outline-none focus:ring-2 focus:ring-accent/30">
          Login with CAS
        </button>
      </form>
    {% else %}
      <button id="google"
        class="mt-6 inline-flex w-full items-center justify-center rounded-xl bg-accent px-4 py-3 font-semibold text-white shadow-sm hover:brightness-95 focus:outline-none focus:ring-2 focus:ring-accent/30">
        Sign in with Yale Email
      </button>

      <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "{{ SUPABASE_URL|e }}";
  const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY|e }}";

  // ✅ one global instance per page load
  if (!window.__sb) {
    window.__sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        flowType: "pkce",
        persistSession: true,
        autoRefreshToken: true,
        // ✅ force the same storage key across pages so PKCE lives in one place
        storageKey: "buttsite-auth"
      }
    });
  }
  const supabase = window.__sb;

  const btn = document.getElementById("google");
  btn?.addEventListener("click", async () => {
    btn.disabled = true;

    try {
      // 1) Nuke any existing Supabase session on this origin
      await supabase.auth.signOut().catch(() => {});

      // (optional) also clear any stale PKCE verifier keys if you like:
      // for (const k of Object.keys(localStorage))
      //   if (k.includes("-auth-token-code-verifier")) localStorage.removeItem(k);

      // 2) Start a brand-new OAuth flow and *force* Google UI
      console.log(location.origin)
      await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: `${location.origin}/auth/callback`,
          // Show account picker, and re-consent to avoid silent reuse
          queryParams: {
            prompt: "select_account consent",

            // optional: request offline access/refresh token from Google side
            // access_type: "offline"
          },
          // optional: scopes: "email profile"
        }
      });

      // Page will redirect if successful
    } catch (e) {
      console.error("Login start failed:", e);
      btn.disabled = false; // only re-enable if we didn't redirect
      alert("Could not start Google sign-in. Please try again.");
    }
  });
</script>

    {% endif %}
  </div>
</div>
{% endblock %}
