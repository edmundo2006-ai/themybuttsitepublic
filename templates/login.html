{% extends "layout.html" %}
{% block title %}Login{% endblock %}
{% block content %}
<div class="flex items-center justify-center min-h-screen" style="margin-top: -80px;">
  <div class="mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-16 rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm">
    <h1 class="text-center text-3xl font-bold text-gray-900">Welcome to the MY Buttsite!</h1>
    <div class="mt-2 h-1 w-20 bg-accent mx-auto rounded-full"></div>

    {% if session.get('netid') %}
      <p class="mt-6 text-center">Login with Yale Email</p>
      <form method="POST" class="mt-6">
        <button type="submit"
          class="inline-flex w-full items-center justify-center rounded-xl bg-accent px-4 py-3 font-semibold text-white shadow-sm hover:brightness-95 focus:outline-none focus:ring-2 focus:ring-accent/30">
          Login 
        </button>
      </form>
    {% elif CAS_ENABLED %}
      <p class="mt-6 text-center">Login with Yale Email</p>
      <form method="POST" class="mt-6">
        <button type="submit"
          class="inline-flex w-full items-center justify-center rounded-xl bg-accent px-4 py-3 font-semibold text-white shadow-sm hover:brightness-95 focus:outline-none focus:ring-2 focus:ring-accent/30">
          Login with CAS
        </button>
      </form>
  

    {% else %}
      <button id="google"
        class="mt-6 inline-flex w-full items-center justify-center rounded-xl bg-accent px-4 py-3 font-semibold text-white shadow-sm hover:brightness-95 focus:outline-none focus:ring-2 focus:ring-accent/30">
        Sign in with Yale Email
      </button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,   // fallback if popup blocked
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyDL_xUk4uGHbZv8why-RL4svOySFT2Ww50",
    authDomain: "themybuttsite-6a082.firebaseapp.com",
    projectId: "themybuttsite-6a082",
    storageBucket: "themybuttsite-6a082.firebasestorage.app",
    messagingSenderId: "164326695073",
    appId: "1:164326695073:web:08f9a77a4114a4fd2890e0",
    measurementId: "G-WDTCRBYJ6L"
  });
  try { getAnalytics(app); } catch {}

  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" }); // optional: { hd: "yale.edu" }

  // âœ… Only sign out on click if already signed in (fresh chooser)
  async function handleGoogleSignIn() {
    try {
      if (auth.currentUser) {
        try { await signOut(auth); } catch {}
        await new Promise(r => setTimeout(r, 0));
      }
      await signInWithPopup(auth, provider);
    } catch (err) {
      // Graceful fallback if popup blocked or unsupported
      if (err?.code === "auth/popup-blocked" || err?.code === "auth/operation-not-supported-in-this-environment") {
        await signInWithRedirect(auth, provider);
        return;
      }
      console.error("Sign-in failed:", err);
      window.showToast("Sign-in failed. Make sure to use a Yale email to log in.", "danger");
    }
  }

  // After popup completes, Firebase signs the user in; send token to backend
  onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  try {
    const idToken = await user.getIdToken(true);
    const res = await fetch("/firebase", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Requested-With": "fetch" },
      credentials: "include", // <- lets server set your session cookie
      body: JSON.stringify({ idToken })
    });

    const data = await res.json().catch(() => ({}));

    // optional but recommended: sign out client so next page doesn't re-fire
    try { await signOut(auth); } catch {}
    
    if (res.ok && data.ok) {
      window.location.assign(data.next); // success
    } else {
      window.showToast("Login failed. Please use a Yale email.", "danger");
      setTimeout(() => {
        window.location.replace(data.next || "/");
      }, 2500);
    }
  } catch (e) {
    try { await signOut(auth); } catch {}
    console.error("Post-login handoff failed:", e);
    window.location.replace("/");
  }
});

  document.getElementById("google")?.addEventListener("click", handleGoogleSignIn);
</script>


    {% endif %}
  </div>
</div>
{% endblock %}
