{% extends "layout.html" %}

{% block title %}Finishing sign-in…{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-screen" style="margin-top: -80px;">
  <div class="mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-16 rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm">
    <h1 class="text-center text-3xl font-bold text-gray-900">Welcome to the MY Buttsite!</h1>
    <div class="mt-2 h-1 w-20 bg-accent mx-auto rounded-full"></div>

    <div class="mt-6 text-center text-gray-700">
      <p>Finishing sign-in with Google…</p>
      <p class="text-sm text-gray-500 mt-2">Please wait a moment.</p>
    </div>

    <div id="err" class="mt-4 hidden text-red-600 text-sm text-center"></div>

    <div class="mt-8 flex items-center justify-center">
      <!-- cute loading dot -->
      <div class="h-2 w-2 rounded-full bg-accent animate-ping"></div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const supabase = createClient("{{ SUPABASE_URL|e }}","{{ SUPABASE_ANON_KEY|e }}",
    { auth: { persistSession:true, autoRefreshToken:true, flowType:"pkce" } });

  console.log("[cb] starting");

  (async () => {
    // Exchange if a ?code exists (don’t require state)
    const hasCode = new URLSearchParams(location.search).has("code");
    if (hasCode) {
      const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
      if (error) {
        console.error("[cb] exchange failed:", error);
        location.href = "/?error=oauth";
        return;
      }
      // Clean URL
      const u = new URL(location.href);
      u.searchParams.delete("code"); u.searchParams.delete("state");
      history.replaceState({}, "", u);
    }

    const { data: { session }, error: sessErr } = await supabase.auth.getSession();
    if (sessErr || !session?.access_token) {
      console.error("[cb] no client session:", sessErr);
      location.href = "/?error=session";
      return;
    }

    // Tell Flask to create its cookie-backed server session
    const res = await fetch("/auth/api/session", {
      method: "POST",
      headers: { Authorization: `Bearer ${session.access_token}` },
      credentials: "include"
    });
    console.log("[cb] /auth/api/session status", res.status);
    if (!res.ok) {
      location.href = "/?error=server-session";
      return;
    }

    // Let the backend route by role
    location.replace("/auth/api/me");
  })();
</script>
{% endblock %}
