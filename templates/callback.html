{% extends "layout.html" %}

{% block title %}Finishing sign-in…{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-screen" style="margin-top: -80px;">
  <div class="mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-16 rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm">
    <h1 class="text-center text-3xl font-bold text-gray-900">Welcome to the MY Buttsite!</h1>
    <div class="mt-2 h-1 w-20 bg-accent mx-auto rounded-full"></div>

    <div class="mt-6 text-center text-gray-700">
      <p>Finishing sign-in with Google…</p>
      <p class="text-sm text-gray-500 mt-2">Please wait a moment.</p>
    </div>

    <div id="err" class="mt-4 hidden text-red-600 text-sm text-center"></div>

    <div class="mt-8 flex items-center justify-center">
      <!-- cute loading dot -->
      <div class="h-2 w-2 rounded-full bg-accent animate-ping"></div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "{{ SUPABASE_URL|e }}";
  const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY|e }}";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, flowType: "pkce" }
  });

  const showErr = (msg) => {
    const el = document.getElementById("err");
    if (el) {
      el.textContent = msg;
      el.classList.remove("hidden");
    }
  };

  (async () => {
    try {
      console.log("origin:", location.origin);

        // 1) read the exact PKCE value
        const pkceKey = 'sb-uvpwwkentdupesoxrtjw-auth-token-code-verifier';
        const verifier = localStorage.getItem(pkceKey);
        console.log("verifier length:", verifier ? verifier.length : 0, "value:", verifier);

        // 2) confirm we have ?code
        const code = new URL(location.href).searchParams.get("code");
        console.log("has code:", !!code, "code:", code);

        // 3) confirm redirect URI consistency: this should equal what you sent in signInWithOAuth
        const expectedRedirect = new URL("/auth/callback", location.origin).href;
        console.log("expectedRedirect:", expectedRedirect);

      if (code) {
        // Supabase will internally verify state + PKCE for you
        const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
        if (error) {
          console.error("exchangeCodeForSession failed:", error);
          showErr("Sign-in failed. Please try again.");
          return;
        }
        // Clean up query params from the URL bar
        url.searchParams.delete("code");
        window.history.replaceState({}, "", url.toString());
      }

      // We should now have a client session
      const { data: { session }, error: sessErr } = await supabase.auth.getSession();
      if (sessErr || !session?.access_token) {
        console.error("No client session:", sessErr);
        showErr("No active session. Please sign in again.");
        return;
      }

      // Exchange client token -> Flask server session
      const res = await fetch("/auth/api/session", {
        method: "POST",
        headers: { Authorization: `Bearer ${session.access_token}` },
        credentials: "include"
      });

      if (!res.ok) {
        const t = await res.text().catch(() => "");
        console.error("Server session exchange failed", t);
        showErr("Could not create a server session. Please try again.");
        return;
      }

      // Hand off to backend to finish Yale lookup + redirect appropriately
      window.location.replace("/auth/api/me");
    } catch (e) {
      console.error("Callback crashed:", e);
      showErr("Unexpected error during sign-in. Please try again.");
    }
  })();
</script>
{% endblock %}
