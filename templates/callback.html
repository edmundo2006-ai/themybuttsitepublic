{% extends "layout.html" %}

{% block title %}Finishing sign-inâ€¦{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-screen" style="margin-top: -80px;">
  <div class="mx-auto max-w-md px-4 sm:px-6 lg:px-8 py-16 rounded-2xl bg-white ring-1 ring-gray-200 shadow-sm">
    <h1 class="text-center text-3xl font-bold text-gray-900">Welcome to the MY Buttsite!</h1>
    <div class="mt-2 h-1 w-20 bg-accent mx-auto rounded-full"></div>

    <div class="mt-6 text-center text-gray-700">
      <p>Finishing sign-in with Googleâ€¦</p>
      <p class="text-sm text-gray-500 mt-2">Please wait a moment.</p>
    </div>

    <div id="err" class="mt-4 hidden text-red-600 text-sm text-center"></div>

    <div class="mt-8 flex items-center justify-center">
      <!-- cute loading dot -->
      <div class="h-2 w-2 rounded-full bg-accent animate-ping"></div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "{{ SUPABASE_URL|e }}";
  const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY|e }}";

  // âœ… one global instance per page load
  if (!window.__sb) {
    window.__sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        flowType: "pkce",
        persistSession: true,
        autoRefreshToken: true,
        // âœ… force the same storage key across pages so PKCE lives in one place
        storageKey: "buttsite-auth"
      }
    });
  }
  const supabase = window.__sb;

  const showErr = (msg) => {
    const el = document.getElementById("err");
    if (el) {
      el.textContent = msg;
      el.classList.remove("hidden");
    }
  };

  (async () => {
    try {
      // ðŸ‘‡ guard goes here
      if (window.__didExchange) return;
      window.__didExchange = true;

      console.log("origin:", location.origin);

      // 1) read PKCE value
      const pkceKey = 'sb-uvpwwkentdupesoxrtjw-auth-token-code-verifier';
      const verifier = localStorage.getItem(pkceKey);
      console.log("verifier length:", verifier ? verifier.length : 0, "value:", verifier);

      // 2) confirm ?code
      const url = new URL(location.href);
      const code = url.searchParams.get("code");
      console.log("has code:", !!code, "code:", code);

      // 3) expected redirect
      const expectedRedirect = new URL("/auth/callback", location.origin).href;
      console.log("expectedRedirect:", expectedRedirect);

      if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) {
          console.error("exchangeCodeForSession failed:", error);
          showErr("Sign-in failed. Please try again.");
          return;
        }
        // clean URL
        url.searchParams.delete("code");
        url.searchParams.delete("state");
        history.replaceState({}, "", url.toString());
      }

      // confirm session
      const { data: { session }, error: sessErr } = await supabase.auth.getSession();
      if (sessErr || !session?.access_token) {
        console.error("No client session:", sessErr);
        showErr("No active session. Please sign in again.");
        return;
      }

      // exchange client token -> Flask server session
      const res = await fetch("/auth/api/session", {
        method: "POST",
        headers: { Authorization: `Bearer ${session.access_token}` },
        credentials: "include"
      });

      if (!res.ok) {
        const t = await res.text().catch(() => "");
        console.error("Server session exchange failed", t);
        showErr("Could not create a server session. Please try again.");
        return;
      }

      // hand off to backend
      window.location.replace("/auth/api/me");
    } catch (e) {
      console.error("Callback crashed:", e);
      showErr("Unexpected error during sign-in. Please try again.");
    }
  })();
</script>
{% endblock %}
